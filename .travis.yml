language: c

git:
  depth: 5

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - gcc-4.8-multilib
      - linux-libc-dev
      - linux-libc-dev:i386

env:
  global:
    - DEPLOY_LIBS="libED_CSVFile.a libED_INIFile.a libED_JSONFile.a libED_MATFile.a libED_XLSFile.a libED_XLSXFile.a libED_XMLFile.a libbsxml-json.a libexpat.a libminizip.a libparson.a libxml2.a libxlsreader.a libzlib.a"
    # BBPASS
    - secure: "QTj7LL9IODoPLwiha1ZZOkaPmgP4V9yVBJG4Z9qjm54Zv7UYHwHX1ghDN+DkzlPbNUXBBhclekmyCsxiZI9JZsYBWl84p33VrSTWD5eGQ4M6jJaXIiXk8hsStKHNfeq3FB+Bc+0R5ST0/OdyMex8sNfW9nntRbkjDT5jRdrbt/KG694dj5YvmL/E+RdLfXe6a/y3wlGXF6N/0Z9cHtP0TKgEQij/+KrGPk5qxwbAzYbT9jzmgGBbH8WHV1l8FtlVCYio7PVDswGkYgsMPn2lS3VZxOmZn5XJyYkOPQE3Fxlsr/50q2kHe4ufIX8U03upHvmW2FuXaPxar7ssAORPFIF+zKcKpCCMz6mfHgQB20tefqr2EvfTV6UJIx4pnUCJ5pzrlEBI3AQcUjQwFv0HnGeK/wiQFlny85POuoKN9V+jwUAxoXhnCZFLO2D8n4uyplvwximifEuaQ1gd835dan2ngGp0Ws6psnYC4iLJ6aULbD0EIc1aAbf3H+NF3GfqKhH4nz18eHNbd0ghMbTSvKWm2eKb9oX8anuCZtO0VO79A6lu8A86ZthnAS1dQ3J2KR7/xjug75nqlBpXHcIFB40sfl/zQntCK5SNMzGGojNWn/SGEDf7jon9esda3dtmHMo6mFNUTA/CX4E+xGjtpaafyCnOo82a/FD3wu8kjy4="

matrix:
  include:
    - os: linux
      compiler: gcc-4.8
      env:
        - PLATFORM=linux32
        - CFLAGS="-O3 -DNDEBUG -fPIC -msse2 -m32"
        - CXXFLAGS="-O3 -DNDEBUG -fPIC -msse2 -m32"
        - CMAKE=/opt/cmake-3.18.6-Linux-x86_64/bin/cmake
        - TARGETDIR="linux32"
        - GM="Unix Makefiles"
        - MAKE=make
    - os: linux
      compiler: gcc-4.8
      env:
        - PLATFORM=linux64
        - CFLAGS="-O3 -DNDEBUG -fPIC"
        - CXXFLAGS="-O3 -DNDEBUG -fPIC"
        - CMAKE=/opt/cmake-3.18.6-Linux-x86_64/bin/cmake
        - TARGETDIR="linux64"
        - GM="Unix Makefiles"
        - MAKE=make
    - os: linux
      compiler: clang
      env:
        - PLATFORM=linux64
        - CFLAGS="-O3 -DNDEBUG -fPIC"
        - CXXFLAGS="-O3 -DNDEBUG -fPIC"
        - CMAKE=/opt/cmake-3.18.6-Linux-x86_64/bin/cmake
        - TARGETDIR="linux64"
        - GM="Unix Makefiles"
        - MAKE=make
    - os: osx
      compiler: gcc
      env:
        - PLATFORM=darwin64
        - CC=gcc
        - CMAKE=cmake
        - TARGETDIR="darwin64"
        - GM="Unix Makefiles"
        - MAKE=make
    - os: windows
      compiler: gcc
      env:
        - PLATFORM=mingw32
        - CC=gcc
        - CMAKE=cmake
        - TARGETDIR="mingw32"
        - GM="MinGW Makefiles"
        - MAKE=mingw32-make
    - os: windows
      compiler: gcc
      env:
        - PLATFORM=mingw64
        - CC=gcc
        - CMAKE=cmake
        - TARGETDIR="mingw64"
        - GM="MinGW Makefiles"
        - MAKE=mingw32-make

before_install:
  - |-
    case $TRAVIS_OS_NAME in
      linux)
        curl -sSL https://cmake.org/files/v3.18/cmake-3.18.6-Linux-x86_64.tar.gz | sudo tar -xzC /opt
        ;;
      osx)
        ## do not update, it seems to just waste resources and is never able to finish
        ## brew update
        ;;
      windows)
        ## mostly from here: https://docs.travis-ci.com/user/reference/windows/
        [[ ! -f C:/tools/msys64/msys2_shell.cmd ]] && rm -rf C:/tools/msys64
        choco uninstall -y mingw
        choco upgrade --no-progress -y msys2
        export msys2='cmd //C RefreshEnv.cmd '
        export msys2+='& set MSYS=winsymlinks:nativestrict '
        export msys2+='& C:\\tools\\msys64\\msys2_shell.cmd -defterm -no-start'
        ## 32bit mingw
        export mingw32="$msys2 -mingw32 -full-path -here -c \$\* --"
        ## 64bit mingw
        export mingw64="$msys2 -mingw64 -full-path -here -c \$\* --"
        export msys2+=" -msys2 -c \$\* --"
        $msys2 pacman --sync --noconfirm --needed autoconf autoconf-archive automake automake-wrapper binutils gettext git libtool m4 make pkg-config mingw-w64-{i686,x86_64}-toolchain mingw-w64-{i686,x86_64}-clang mingw-w64-{i686,x86_64}-make mingw-w64-{i686,x86_64}-cmake mingw-w64-{i686,x86_64}-extra-cmake-modules mingw-w64-{i686,x86_64}-{gcc,binutils} mingw-w64-{i686,x86_64}-hdf5
        ## Install more MSYS2 packages from https://packages.msys2.org/base here
        taskkill //IM gpg-agent.exe //F  # https://travis-ci.community/t/4967
        export PATH=/C/tools/msys64/mingw64/bin:$PATH
        ;;
    esac
  - curl https://bitbucket.org/Swyter/bitbucket-curl-upload-to-repo-downloads/raw/default/upload-to-bitbucket.sh -O -J -L
  - chmod +x ./upload-to-bitbucket.sh
  - git clone --branch v2.9.12 --depth 1 https://gitlab.gnome.org/GNOME/libxml2
  - mkdir -p libxml2/$PLATFORM

before_cache:
  - |-
    case $TRAVIS_OS_NAME in
      windows)
        # https://unix.stackexchange.com/a/137322/107554
        $msys2 pacman --sync --clean --noconfirm
        ;;
    esac

cache:
  directories:
    - $HOME/AppData/Local/Temp/chocolatey
    - /C/tools/msys64

script:
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]] && [[ "$PLATFORM" == "linux32" ]]; then ./.build.sh CFLAGS="-O3 -msse2 -m32 -fPIC"; fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]] && [[ "$PLATFORM" == "linux64" ]]; then ./.build.sh CFLAGS="-O3 -fPIC"; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then ./.build.sh CFLAGS="-O3"; fi
  - if [[ "$TRAVIS_OS_NAME" == "windows" ]] && [[ "$PLATFORM" == "mingw32" ]]; then $mingw32 ./.build.sh CFLAGS="-O3"; fi
  - if [[ "$TRAVIS_OS_NAME" == "windows" ]] && [[ "$PLATFORM" == "mingw64" ]]; then $mingw64 ./.build.sh CFLAGS="-O3"; fi

after_success:
  - |-
    case $TRAVIS_OS_NAME in
      linux)
        if [[ "$CC" == "gcc-4.8" ]]; then sh ./upload-to-bitbucket.sh tbeu $BBPASS /tbeu/downloads/downloads ./ExternData/Resources/Library/$PLATFORM/ExternData_$PLATFORM.tar.xz; fi
        ;;
      osx)
        ./upload-to-bitbucket.sh tbeu $BBPASS /tbeu/downloads/downloads ./ExternData/Resources/Library/$PLATFORM/ExternData_$PLATFORM.tar.xz
        ;;
      windows)
        case $PLATFORM in
          mingw32)
            $mingw32 ./upload-to-bitbucket.sh tbeu $BBPASS /tbeu/downloads/downloads ./ExternData/Resources/Library/$PLATFORM/ExternData_$PLATFORM.tar.xz
            ;;
          mingw64)
            $mingw64 ./upload-to-bitbucket.sh tbeu $BBPASS /tbeu/downloads/downloads ./ExternData/Resources/Library/$PLATFORM/ExternData_$PLATFORM.tar.xz
            ;;
        esac
        ;;
    esac

notifications:
  email: false
